<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IonSystemBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">software.amazon.ion:ion-java</a> &gt; <a href="index.source.html" class="el_package">software.amazon.ion.system</a> &gt; <span class="el_source">IonSystemBuilder.java</span></div><h1>IonSystemBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2011-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at:
 *
 *     http://aws.amazon.com/apache2.0/
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific
 * language governing permissions and limitations under the License.
 */

package software.amazon.ion.system;

import static software.amazon.ion.impl.lite.PrivateLiteDomTrampoline.newLiteSystem;

import software.amazon.ion.IonCatalog;
import software.amazon.ion.IonReader;
import software.amazon.ion.IonSystem;
import software.amazon.ion.IonWriter;
import software.amazon.ion.SymbolTable;
import software.amazon.ion.impl.PrivateIonBinaryWriterBuilder;
import software.amazon.ion.impl.PrivateUtils;

/**
 * The builder for creating {@link IonSystem}s.
 * Most applications will only have one or two system instances;
 * see {@link IonSystem} for important constraints.
 * &lt;p&gt;
 * Builders may be configured once and reused to construct multiple
 * objects. They can be {@link #copy() copied} to create a mutable
 * copy of a prototype (presumably for altering some property).
 * &lt;p&gt;
 * &lt;b&gt;Instances of this class are not safe for use by multiple threads unless
 * they are {@linkplain #immutable() immutable}.&lt;/b&gt;
 * &lt;p&gt;
 * The easiest way to get going is to use the {@link #standard()} builder:
 *&lt;pre&gt;
 *    IonSystem ion = IonSystemBuilder.standard().build();
 *&lt;/pre&gt;
 * &lt;p&gt;
 * However, most long-lived applications will want to provide a custom
 * {@link IonCatalog} implementation rather than using the default
 * {@link SimpleCatalog}.  For example:
 *&lt;pre&gt;
 *    IonCatalog catalog = newCustomCatalog();
 *    IonSystemBuilder b = IonSystemBuilder.standard().copy();
 *    b.setCatalog(catalog);
 *    IonSystem ion = b.build();
 *&lt;/pre&gt;
 * &lt;p&gt;
 * Configuration properties follow the standard JavaBeans idiom in order to be
 * friendly to dependency injection systems.  They also provide alternative
 * mutation methods that enable a more fluid style:
 *&lt;pre&gt;
 *    IonCatalog catalog = newCustomCatalog();
 *    IonSystem ion = IonSystemBuilder.standard()
 *                                    .withCatalog(catalog)
 *                                    .build();
 *&lt;/pre&gt;
 *
 * &lt;h2&gt;Configuration Properties&lt;/h2&gt;
 * &lt;p&gt;
 * This builder provides the following configurable properties:
 * &lt;ul&gt;
 *   &lt;li&gt;
 *     &lt;b&gt;catalog&lt;/b&gt;: The {@link IonCatalog} used as a default when reading Ion
 *     data. If null, each system will be built with a new
 *     {@link SimpleCatalog}.
 *   &lt;/li&gt;
 *   &lt;li&gt;
 *     &lt;b&gt;streamCopyOptimized&lt;/b&gt;: When true, this enables optimizations when
 *     copying data between two Ion streams. For example, in some cases raw
 *     binary-encoded Ion can be copied directly from the input to the output.
 *     This can have significant performance benefits when the appropriate
 *     conditions are met. &lt;b&gt;This feature is experimental! Please test
 *     thoroughly and report any issues.&lt;/b&gt;
 *   &lt;/li&gt;
 * &lt;/ul&gt;
 */
public class IonSystemBuilder
{
<span class="fc" id="L85">    private static final IonSystemBuilder STANDARD = new IonSystemBuilder();</span>

    /**
     * The standard builder of {@link IonSystem}s.
     * See the class documentation for the standard configuration.
     * &lt;p&gt;
     * The returned instance is immutable.
     */
    public static IonSystemBuilder standard()
    {
<span class="fc" id="L95">        return STANDARD;</span>
    }


    //=========================================================================

    IonCatalog myCatalog;
<span class="fc" id="L102">    boolean myStreamCopyOptimized = false;</span>


    /** You no touchy. */
<span class="fc" id="L106">    private IonSystemBuilder() {}</span>

    private IonSystemBuilder(IonSystemBuilder that)
<span class="fc" id="L109">    {</span>
<span class="fc" id="L110">        this.myCatalog      = that.myCatalog;</span>
<span class="fc" id="L111">        this.myStreamCopyOptimized = that.myStreamCopyOptimized;</span>
<span class="fc" id="L112">    }</span>

    //=========================================================================

    /**
     * Creates a mutable copy of this builder.
     * @return a new builder with the same configuration as {@code this}.
     */
    public final IonSystemBuilder copy()
    {
<span class="fc" id="L122">        return new Mutable(this);</span>
    }

    /**
     * Returns an immutable builder configured exactly like this one.
     *
     * @return this instance, if immutable;
     * otherwise an immutable copy of this instance.
     */
    public IonSystemBuilder immutable()
    {
<span class="fc" id="L133">        return this;</span>
    }

    /**
     * Returns a mutable builder configured exactly like this one.
     *
     * @return this instance, if mutable;
     * otherwise a mutable copy of this instance.
     */
    public IonSystemBuilder mutable()
    {
<span class="fc" id="L144">        return copy();</span>
    }

    void mutationCheck()
    {
<span class="fc" id="L149">        throw new UnsupportedOperationException(&quot;This builder is immutable&quot;);</span>
    }


    //=========================================================================
    // Properties

    /**
     * Gets the catalog to use when building an {@link IonSystem}.
     * By default, this property is null.
     *
     * @see #setCatalog(IonCatalog)
     * @see #withCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     */
    public final IonCatalog getCatalog()
    {
<span class="fc" id="L166">        return myCatalog;</span>
    }

    /**
     * Sets the catalog to use when building an {@link IonSystem}.
     *
     * @param catalog the catalog to use in built systems.
     *  If null, each system will be built with a new {@link SimpleCatalog}.
     *
     * @see #getCatalog()
     * @see #withCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     *
     * @throws UnsupportedOperationException if this is immutable.
     */
    public final void setCatalog(IonCatalog catalog)
    {
<span class="fc" id="L183">        mutationCheck();</span>
<span class="fc" id="L184">        myCatalog = catalog;</span>
<span class="fc" id="L185">    }</span>

    /**
     * Declares the catalog to use when building an {@link IonSystem},
     * returning a new mutable builder if this is immutable.
     *
     * @param catalog the catalog to use in built systems.
     *  If null, each system will be built with a new {@link SimpleCatalog}.
     *
     * @see #getCatalog()
     * @see #setCatalog(IonCatalog)
     * @see IonSystem#getCatalog()
     */
    public final IonSystemBuilder withCatalog(IonCatalog catalog)
    {
<span class="fc" id="L200">        IonSystemBuilder b = mutable();</span>
<span class="fc" id="L201">        b.setCatalog(catalog);</span>
<span class="fc" id="L202">        return b;</span>
    }


    //=========================================================================


    /**
     * Indicates whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data.
     * By default, this property is false.
     *
     * @see #setStreamCopyOptimized(boolean)
     * @see #withStreamCopyOptimized(boolean)
     */
    public final boolean isStreamCopyOptimized()
    {
<span class="fc" id="L219">        return myStreamCopyOptimized;</span>
    }

    /**
     * Declares whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data.
     * By default, this property is false.
     * &lt;p&gt;
     * &lt;b&gt;This feature is experimental! Please test thoroughly and report any
     * issues.&lt;/b&gt;
     *
     * @throws UnsupportedOperationException if this is immutable.
     *
     * @see #isStreamCopyOptimized()
     * @see #withStreamCopyOptimized(boolean)
     */
    public final void setStreamCopyOptimized(boolean optimized)
    {
<span class="fc" id="L237">        mutationCheck();</span>
<span class="fc" id="L238">        myStreamCopyOptimized = optimized;</span>
<span class="fc" id="L239">    }</span>

    /**
     * Declares whether built systems may attempt to optimize
     * {@link IonWriter#writeValue(IonReader)} by copying raw source data,
     * returning a new mutable builder if this is immutable.
     * &lt;p&gt;
     * &lt;b&gt;This feature is experimental! Please test thoroughly and report any
     * issues.&lt;/b&gt;
     *
     * @see #isStreamCopyOptimized()
     * @see #setStreamCopyOptimized(boolean)
     */
    public final IonSystemBuilder withStreamCopyOptimized(boolean optimized)
    {
<span class="fc" id="L254">        IonSystemBuilder b = mutable();</span>
<span class="fc" id="L255">        b.setStreamCopyOptimized(optimized);</span>
<span class="fc" id="L256">        return b;</span>
    }



    //=========================================================================

    /**
     * Builds a new {@link IonSystem} instance based on this builder's
     * configuration properties.
     */
    public final IonSystem build()
    {
        IonCatalog catalog =
<span class="fc bfc" id="L270" title="All 2 branches covered.">            (myCatalog != null ? myCatalog : new SimpleCatalog());</span>

        IonTextWriterBuilder twb =
<span class="fc" id="L273">            IonTextWriterBuilder.standard().withCharsetAscii();</span>
<span class="fc" id="L274">        twb.setCatalog(catalog);</span>

        PrivateIonBinaryWriterBuilder bwb =
<span class="fc" id="L277">            PrivateIonBinaryWriterBuilder.standard();</span>
<span class="fc" id="L278">        bwb.setCatalog(catalog);</span>
<span class="fc" id="L279">        bwb.setStreamCopyOptimized(myStreamCopyOptimized);</span>

        // TODO Would be nice to remove this since it's implied by the BWB.
        //      However that currently causes problems in the IonSystem
        //      constructors (which get a null initialSymtab).
<span class="fc" id="L284">        SymbolTable systemSymtab = PrivateUtils.systemSymtab(1);</span>
<span class="fc" id="L285">        bwb.setInitialSymbolTable(systemSymtab);</span>
        // This is what we need, more or less.
//        bwb = bwb.fillDefaults();

<span class="fc" id="L289">        IonReaderBuilder rb = IonReaderBuilder.standard().withCatalog(catalog);</span>
<span class="fc" id="L290">        return newLiteSystem(twb, bwb, rb);</span>
    }

    //=========================================================================

    private static final class Mutable
        extends IonSystemBuilder
    {
        private Mutable(IonSystemBuilder that)
        {
<span class="fc" id="L300">            super(that);</span>
<span class="fc" id="L301">        }</span>

        @Override
        public IonSystemBuilder immutable()
        {
<span class="fc" id="L306">            return new IonSystemBuilder(this);</span>
        }

        @Override
        public IonSystemBuilder mutable()
        {
<span class="fc" id="L312">            return this;</span>
        }

        @Override
        void mutationCheck()
        {
<span class="fc" id="L318">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>